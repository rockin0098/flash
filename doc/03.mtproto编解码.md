### mtproto编解码

*参考https://core.telegram.org/mtproto*

由于只测试过 android / ios / tdesktop , 这三种客户端都是使用 TCP 协议, 所以一下内容仅包含对这三种客户端的协议分析

#### codec 选择协议

官方说明参见 https://core.telegram.org/mtproto TCP transport 章节

实际测试中, android / ios / tdesktop 发送的 codec 选择协议部分都是64字节内容,并不含上述协议版本标识符,是标准协议。以下只对这一种情况进行说明。

TCP 客户端与服务端建立TCP连接后, 会马上发送一个握手消息, 但是这个TCP连接的第一个消息并不是完全符合 mtproto 协议的TL语言定义的。
这个消息的前固定64字节，是告诉服务器需要对该客户端后续选择TCP协议的codec, 并告知服务端网络通信密钥。详细如下

![](https://raw.githubusercontent.com/rockin0098/meow/dev/doc/pictures/first_64bytes.png)

1. 1~4 字节为 codec 标记判断
2. 5～64 字节为通信解密密钥及iv,其返回消息通信加密密钥需要根据解密密钥运算得出,具体计算方法见 ```SelectCodec``` 函数
3. 解密后前64字节中的56~59 字节其值必须为 0xefefefef

服务端得到通信加密密钥后可以开始对后续消息进行解密
一个完整的mtproto消息, 第1或前4字节表示消息长度,后续则是 TL language 定义的具体消息

##### 消息长度

第一个字节为 [0x01-0x7f] 之间的值时, 长度用一个字节表示,其值为 第一个字节的整数之 * 4
第一个字节为 大于等于 0x7f 时, 长度用三个字节表示,其值为 
size = (int(b2[0]) | int(b2[1])<<8 | int(b2[2])<<16) << 2
b2为2~4字节


#### 未加密消息
上图64字节之后的消息内容,处理消息长度及读取后续完整内容，解密后为 00000000000000000000000001a7f75b14000000789746601484c8e6caae93c5d77e310bef7a560b
可以对应官方消息结构说明

![](https://raw.githubusercontent.com/rockin0098/meow/dev/doc/pictures/mtproto_msg.jpeg)

* auth_key_id 为0 则表示这个消息是未加密消息, 一般只有握手消息等少数几个消息是未加密消息
* auth_key_id 不为0 则表示这个消息是加密消息, 绝大部分消息都是加密消息, 需要通过 auth_key 来对消息进行解密
